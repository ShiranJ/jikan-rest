services:
  - type: web
    name: jikan-api
    runtime: image
    image:
      url: jikanme/jikan-rest:latest
    region: oregon
    plan: free
    healthCheckPath: /
    
    startCommand: |
      sh -c '
      echo "=== Generating .env file ===" &&
      cat > /app/.env <<EOF
      APP_NAME=Jikan
      APP_ENV=production
      APP_KEY=base64:$(openssl rand -base64 32)
      APP_DEBUG=false
      APP_URL=${APP_URL:-https://jikan-api-j7jn.onrender.com}
      
      LOG_CHANNEL=stderr
      LOG_LEVEL=error
      
      DB_CONNECTION=mongodb
      MONGODB_DSN=${MONGODB_DSN}
      
      CACHE_DRIVER=redis
      QUEUE_CONNECTION=sync
      SESSION_DRIVER=file
      
      REDIS_HOST=${REDIS_HOST}
      REDIS_PASSWORD=
      REDIS_PORT=${REDIS_PORT:-6379}
      REDIS_CLIENT=phpredis
      EOF
      echo "=== Starting RoadRunner ===" &&
      /app/rr serve -c /app/.rr.yaml
      '
    
    envVars:
      # No password here - uses variable reference
      - key: MONGODB_DSN
        sync: false  # This means "I'll set it in Render dashboard"
      
      - key: REDIS_HOST
        fromService:
          type: redis
          name: jikan-redis
          property: host
      - key: REDIS_PORT
        value: "6379"
      - key: APP_ENV
        value: production

  - type: redis
    name: jikan-redis
    region: oregon
    plan: free
    maxmemoryPolicy: allkeys-lru
    ipAllowList:
      - source: 0.0.0.0/0
        description: Allow all
